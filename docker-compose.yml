version: "3"
services:

  oase-base:
    image: exastro/oase-base:${OASE_VERSION:-latest}
    container_name: oase-base
    hostname: oase-base
    restart: on-failure
    tty: true
    build:
      context: ./oase-base
      dockerfile: ./Dockerfile
      args:
        - OASE_VERSION=${OASE_VERSION}

  oase-backyard:
    image: exastro/oase-backyard:${OASE_VERSION:-latest}
    container_name: oase-backyard
    hostname: oase-backyard
    restart: on-failure
    tty: true
    build:
      context: ./oase-backyard
      dockerfile: ./Dockerfile
      args:
        - OASE_VERSION=${OASE_VERSION}
    environment:
      MARIADB_DATABASE: ${MARIADB_DATABASE}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}

  oase-web:
    image: exastro/oase-web:${OASE_VERSION:-latest}
    container_name: oase-web
    hostname: oase-web
    restart: on-failure
    tty: true
    build:
      context: ./oase-web
      dockerfile: ./Dockerfile
      args:
        - OASE_VERSION=${OASE_VERSION:-latest}
    environment:
      MARIADB_DATABASE: ${MARIADB_DATABASE}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
    volumes:
      - ./oase-agent/logs:/exastro/OASE/oase-root/logs/webaplogs
      - ./oase-apply/volume/exastro/rule:/exastro/rule
      - ./oase-apply/volume/exastro/OASE/oase-root/temp/rule:/exastro/OASE/oase-root/temp/rule
      - oase-m2-repository:/root/.m2/repository/com/oase
    ports:
      - '${OASE_HTTP_PORT:-80}:80'
    networks:
      - public
      - private

  oase-apply:
    image: exastro/oase-apply:${OASE_VERSION:-latest}
    container_name: oase-apply
    hostname: oase-apply
    restart: on-failure
    tty: true
    build:
      context: ./oase-apply
      dockerfile: ./Dockerfile
      args:
        - OASE_VERSION=${OASE_VERSION:-latest}
    environment:
      MARIADB_DATABASE: ${MARIADB_DATABASE}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
    volumes:
      # - ./oase-agent/logs:/exastro/OASE/oase-root/logs/backyardlogs/oase_apply
      - ./oase-apply/volume/exastro/rule:/exastro/rule
      - ./oase-apply/volume/exastro/OASE/oase-root/temp/rule:/exastro/OASE/oase-root/temp/rule
      - oase-m2-repository:/root/.m2/repository/com/oase
    networks:
      - private

  oase-accept:
    image: exastro/oase-accept:${OASE_VERSION:-latest}
    container_name: oase-accept
    hostname: oase-accept
    restart: on-failure
    tty: true
    build:
      context: ./oase-accept
      dockerfile: ./Dockerfile
      args:
        - OASE_VERSION=${OASE_VERSION:-latest}
    environment:
      MARIADB_DATABASE: ${MARIADB_DATABASE}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
    volumes:
      - ./oase-agent/logs:/exastro/OASE/oase-root/logs/backyardlogs/oase_accept
    networks:
      - private

  oase-agent:
    image: exastro/oase-agent:${OASE_VERSION:-latest}
    container_name: oase-agent
    hostname: oase-agent
    restart: on-failure:3
    tty: true
    build:
      context: ./oase-agent
      dockerfile: ./Dockerfile
      args:
        - OASE_VERSION=${OASE_VERSION:-latest}
    environment:
      MARIADB_DATABASE: ${MARIADB_DATABASE}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
    volumes:
      - ./oase-agent/logs:/exastro/OASE/oase-root/logs/backyardlogs/oase_agent
    networks:
      - private

  oase-action:
    image: exastro/oase-action:${OASE_VERSION:-latest}
    container_name: oase-action
    hostname: oase-action
    restart: on-failure:3
    tty: true
    build:
      context: ./oase-action
      dockerfile: ./Dockerfile
      args:
        - OASE_VERSION=${OASE_VERSION:-latest}
    environment:
      MARIADB_DATABASE: ${MARIADB_DATABASE}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
    volumes:
      - ./oase-agent/logs:/exastro/OASE/oase-root/logs/backyardlogs/oase_action
    networks:
      - private

  oase-ita-collaboration:
    image: exastro/oase-ita-collaboration:${OASE_VERSION:-latest}
    container_name: oase-ita-collaboration
    hostname: oase-ita-collaboration
    restart: on-failure:3
    tty: true
    build:
      context: ./oase-ita-collaboration
      dockerfile: ./Dockerfile
      args:
        - OASE_VERSION=${OASE_VERSION:-latest}
    environment:
      MARIADB_DATABASE: ${MARIADB_DATABASE}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
    volumes:
      - ./oase-agent/logs:/exastro/OASE/oase-root/logs/backyardlogs/exastro_collaboration
    networks:
      - private

  oase-servicenow-notification:
    image: exastro/oase-servicenow-notification:${OASE_VERSION:-latest}
    container_name: oase-servicenow-notification
    hostname: oase-servicenow-notification
    restart: on-failure:3
    tty: true
    build:
      context: ./oase-servicenow-notification
      dockerfile: ./Dockerfile
      args:
        - OASE_VERSION=${OASE_VERSION:-latest}
    environment:
      MARIADB_DATABASE: ${MARIADB_DATABASE}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
    volumes:
      - ./oase-agent/logs:/exastro/OASE/oase-root/logs/backyardlogs/servicenow_notification
    networks:
      - private

  oase-zabbix-monitoring:
    image: exastro/oase-zabbix-monitoring:${OASE_VERSION:-latest}
    container_name: oase-zabbix-notification
    hostname: oase-zabbix-notification
    restart: on-failure:3
    tty: true
    build:
      context: ./oase-zabbix-monitoring
      dockerfile: ./Dockerfile
      args:
        - OASE_VERSION=${OASE_VERSION:-latest}
    environment:
      MARIADB_DATABASE: ${MARIADB_DATABASE}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
    volumes:
      - ./oase-agent/logs:/exastro/OASE/oase-root/logs/backyardlogs/oase_monitoring
      - ./oase-zabbix-monitoring/volume/exastro/OASE/oase-root/temp/exclusive:/exastro/OASE/oase-root/temp/exclusive
      - ./oase-zabbix-monitoring/volume/exastro/OASE/oase-root/temp/monitor:/exastro/OASE/oase-root/temp/monitor
    networks:
      - public
      - private

  oase-setup:
    image: exastro/oase-setup:${OASE_VERSION:-latest}
    container_name: oase-setup
    hostname: oase-setup
    restart: on-failure:3
    tty: true
    build:
      context: ./oase-setup
      dockerfile: ./Dockerfile
      args:
        - OASE_VERSION=${OASE_VERSION:-latest}
    environment:
      MARIADB_DATABASE: ${MARIADB_DATABASE}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
      RABBITMQ_USER: ${RABBITMQ_USER}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      DROOLS_USER_NAME: ${DROOLS_USER_NAME}
      DROOLS_USER_PASSWORD: ${DROOLS_USER_PASSWORD}
    networks:
      - private
    depends_on:
      - oase-mariadb

  oase-rabbitmq:
    image: rabbitmq:3.9.8-management
    container_name: oase-rabbitmq
    hostname: oase-rabbitmq
    restart: on-failure
    tty: true
    ports:
      # - '4369:4369'
      # - '5671:5671'
      - '5672:5672'
      # - '15691:15691'
      # - '15692:15692'
      - '15672:15672'
      # - '25672:25672'
    # volumes:
      # - rabbitmq-data:/var/lib/rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    networks:
      - public
      - private

  oase-mariadb:
    image: mariadb:10.6.4
    container_name: oase-mariadb
    hostname: oase-mariadb
    restart: on-failure
    tty: true
    ports:
      - "3306:3306"
    environment:
      TZ: "Asia/Tokyo"
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MARIADB_DATABASE: ${MARIADB_DATABASE}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
      MARIADB_ROOT_HOST: "%"
    # volumes:
      # - ./configs/server.cnf:/etc/my.cnf.d/server.cnf
      # - mariadb-data:/var/lib/mysql
    networks:
      - private

  it-automation:
    image: exastro/it-automation:1.9.0-ja
    container_name: it-automation
    hostname: it-automation
    restart: on-failure
    tty: true
    privileged: true
    ports:
      - ${ITA_HTTP_PORT:-51080}:80
      - ${ITA_HTTPS_PORT:-51443}:443
    networks:
      - private

  oase-business-central:
    image: exastro/oase-business-central:${OASE_VERSION:-latest}
    container_name: oase-business-central
    hostname: oase-business-central
    restart: on-failure
    tty: true
    build:
      context: ./oase-business-central
      dockerfile: ./Dockerfile
      args:
        - OASE_VERSION=${OASE_VERSION:-latest}
    ports:
      - ${BUSINESS-CENTRAL_PORT:-8080}:8080
    environment:
    #   TZ: "Asia/Tokyo"
      DROOLS_USER_NAME: ${DROOLS_USER_NAME}
      DROOLS_USER_PASSWORD: ${DROOLS_USER_PASSWORD}
      DROOLS_USER_ROLE: ${DROOLS_USER_ROLE}
    #   MARIADB_DATABASE: ${MARIADB_DATABASE}
    #   MARIADB_USER: ${MARIADB_USER}
    #   MARIADB_PASSWORD: ${MARIADB_PASSWORD}
    volumes:
#      - oase-business-central:/opt/jboss/wildfly
      - oase-m2-repository:/opt/jboss/.m2/repository/com/oase
    networks:
      - private

  oase-kie-server:
    image: exastro/oase-kie-server:${OASE_VERSION:-latest}
    container_name: oase-kie-server
    hostname: oase-kie-server
    restart: on-failure
    tty: true
    build:
      context: ./oase-kie-server
      dockerfile: ./Dockerfile
      args:
        - OASE_VERSION=${OASE_VERSION:-latest}
    ports:
      - ${KIE_SERVER_HTTP:-8180}:8080
    volumes:
      - oase-m2-repository:/opt/jboss/.m2/repository/com/oase
    environment:
      DROOLS_USER_NAME: ${DROOLS_USER_NAME}
      DROOLS_USER_PASSWORD: ${DROOLS_USER_PASSWORD}
      DROOLS_USER_ROLE: ${DROOLS_USER_ROLE}
      KIE_SERVER_LOCATION: http://oase-kie-server:8080/kie-server/services/rest/server
      KIE_SERVER_CONTROLLER: http://oase-business-central:8080/business-central/rest/controller
      KIE_MAVEN_REPO: http://oase-business-central:8080/business-central/maven2
    volumes:
#      - oase-kie-server:/opt/jboss/wildfly
      - oase-m2-repository:/opt/jboss/.m2/repository/com/oase
    depends_on:
      - oase-business-central
    networks:
      - private

volumes:
  oase-m2-repository:
  oase-rabbitmq:
  oase-mariadb:
  oase-business-central:
  oase-kie-server:

networks:
  public:
    driver: bridge
  private:
    driver: bridge

